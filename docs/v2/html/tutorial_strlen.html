<!-- HTML header for doxygen 1.8.20-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="generator" content="Doxygen 1.9.1"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>E.V.E: Building &lt;tt&gt;strlen&lt;/tt&gt;</title>
  <!--<link href="tabs.css" rel="stylesheet" type="text/css"/> REMOVED BY DOXYSTRAP -->
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxystrap.css" rel="stylesheet" type="text/css"/>
  <!-- DOXYSTRAP BLOCK CHANGE BEGIN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
  <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
  <script type="text/javascript" src="doxystrap.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <!-- Custom input to switch branches -->
  <script>
    function switchBranchAction() {
      var branch = document.getElementById("branch_input").value;
      var form = this;
      window.location.href = window.location.hostname + '/en/' + branch;
    }
  </script>
  <!-- DOXYSTRAP BLOCK CHANGE END -->
</head>
<body>
  <!-- DOXYSTRAP BLOCK CHANGE BEGIN -->
  <nav class="navbar navbar-default" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <a href="index.html" class="navbar-brand">E.V.E 0.1-beta</a>
      </div>
    </div>
  </nav>
  <!-- DOXYSTRAP BLOCK CHANGE END -->
  <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
    <!-- DOXYSTRAP BLOCK CHANGE BEGIN -->
    <div class="content" id="content">
      <div class="container">
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a href="index.html"><img alt="Logo" src="logo.png" /></a></td>
                <td id="projectalign" style="padding-left: 0.5em;">
                  <div id="projectname">E.V.E
                    &#160;<span id="projectnumber">0.1-beta</span>
                  </div>
                  <!-- BEGIN PROJECT_BRIEF--><div id="projectbrief"></div><!--END PROJECT_BRIEF -->
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="row">
          <div class="col-sm-12 panel " style="padding-bottom: 15px;">
            <div style="margin-bottom: 15px;">
              <!-- DOXYSTRAP BLOCK CHANGE END -->
              <!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  </ul>
</div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Building <code>strlen</code> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md27">Key idea</a><ul><ul><li class="level3"><a href="#autotoc_md28">&lt;tt&gt;reinterpret_cast&lt;/tt&gt;.</a></li>
<li class="level3"><a href="#autotoc_md29">typedef for &lt;tt&gt;eve::wide&lt;std::uint8_t&gt;&lt;/tt&gt;</a></li>
<li class="level3"><a href="#autotoc_md30">&lt;tt&gt;const wide zero{0};&lt;/tt&gt;</a></li>
<li class="level3"><a href="#autotoc_md31">&lt;tt&gt;eve::previous_aligned_address(s);&lt;/tt&gt;</a></li>
<li class="level3"><a href="#autotoc_md32">&lt;tt&gt;eve::unsafe(eve::load)(aligned_s);&lt;/tt&gt;</a></li>
<li class="level3"><a href="#autotoc_md33">&lt;tt&gt;cur == zeroes&lt;/tt&gt;</a></li>
<li class="level3"><a href="#autotoc_md34">&lt;tt&gt;eve::ignore_first ignore / eve::first_true[ignore]&lt;/tt&gt;</a></li>
<li class="level3"><a href="#autotoc_md35">&lt;tt&gt;while (!match) / aligned_s += wide::static_size&lt;/tt&gt;</a></li>
<li class="level3"><a href="#autotoc_md36">&lt;tt&gt;match = eve::first_true(cur == zeroes);&lt;/tt&gt;</a></li>
<li class="level3"><a href="#autotoc_md37">&lt;tt&gt;aligned_s.get() + *match - s&lt;/tt&gt;</a></li>
</ul>
</ul>
</li>
<li class="level1"><a href="#autotoc_md38">Comparison with real strlens</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md__large_hdd_dev_project_eve_doc_tutorial_tutorial01_strlen"></a></p>
<p><em>NOTE: this documentation was valid at <a href="https://github.com/jfalcou/eve/commit/98b73427f16e580853202000d87c0eb0b6739905">commit</a></em></p>
<p>In this tutorial we will introduce some of the basic EVE concepts and see how they come together to implement strlen. <br  />
 The strlen we will implement is discussed in this <a href="https://stackoverflow.com/questions/25566302/vectorized-strlen-getting-away-with-reading-unallocated-memory">stackoverflow</a> and is very close to <a href="https://opensource.apple.com/source/Libc/Libc-997.90.3/x86_64/string/strlen.s">MacOs x86</a> and <a href="https://code.woboq.org/userspace/glibc/sysdeps/aarch64/multiarch/strlen_asimd.S.html">glibc arm-v8</a> implemenations. <br  />
 You can also find this tutorial in <a href="https://youtu.be/d6NcnyXjc3I">this talk</a> though the syntax was updated.</p>
<p><em>NOTE: we are not advocating rewriting <code>strlen</code> with EVE - this was just an example to show the interfaces and to prove that we have high quality codegen.</em></p>
<h1><a class="anchor" id="autotoc_md27"></a>
Key idea</h1>
<p>SIMD allows us to test multiple chars at once for zero and that what will do with EVE. However, how can we read multiple bytes if the string can be less that what we try to read? We are just going to state the solution here: <b>reading a register from an address aligned to the size of the register is safe due to allocations happening in pages</b>. <br  />
 You can find a detailed discussion on <a href="https://stackoverflow.com/questions/25566302/vectorized-strlen-getting-away-with-reading-unallocated-memory">stackoverflow</a> or in <a href="https://youtu.be/d6NcnyXjc3I">this talk</a>.</p>
<p>(insert src/strlen.src.html here)</p>
<p>Let's break it down.</p>
<h3><a class="anchor" id="autotoc_md28"></a>
&lt;tt&gt;reinterpret_cast&lt;/tt&gt;.</h3>
<p><code>char</code> is not guarantied to be a <code>signed char</code> or an <code>unsigned char</code> and can be an individual type. EVE supports <code>int8_t</code> and <code>uint8_t</code> but not weird <code>char</code>, so we have to cast.</p>
<h3><a class="anchor" id="autotoc_md29"></a>
typedef for &lt;tt&gt;eve::wide&lt;std::uint8_t&gt;&lt;/tt&gt;</h3>
<p><code>eve::wide</code> is EVE's abstraction on top of the simd register. By default EVE will select the native register size for your platform. You can override that with an arbitraty power of 2 by providing <code>eve::fixed&lt;N&gt;</code> as a second parameter, which is useful in certain cases.</p>
<h3><a class="anchor" id="autotoc_md30"></a>
&lt;tt&gt;const wide zero{0};&lt;/tt&gt;</h3>
<p>We will compare each element we load with 0 and this populates us a full wide of zeroes. You can construct a wide from a constant or a variable.</p>
<h3><a class="anchor" id="autotoc_md31"></a>
&lt;tt&gt;eve::previous_aligned_address(s);&lt;/tt&gt;</h3>
<p>This returns the previous address aligned to the default width of the register. You can specify an <code>eve::fixed&lt;N&gt;{}</code> as a second parameter if you wanted to override how many elements you needed to align to (for non-default width). There is a convenience template variable <code>eve::lane&lt;N&gt;</code> that has <code>eve::fixed&lt;N&gt;</code> type. It returns a special type eve::aligned_ptr[T, size_t] - second parameter is alignment in bytes. (there is a default = native register size), Here we want the library to take care of all of that, so we just rely on CTAD.</p>
<h3><a class="anchor" id="autotoc_md32"></a>
&lt;tt&gt;eve::unsafe(eve::load)(aligned_s);&lt;/tt&gt;</h3>
<p>We load a <code>wide</code> from <code>aligned_s</code> pointer. There are two ways to do it:</p><ul>
<li><code>wide(ptr)</code> constructor</li>
<li><code>eve::load</code> function Here we are perfectly fine doing either of those until we decide to use our strlen with dynamic analysis. As was mentioned previously, it is OK to load from an aligned address but not from the view of C++. The dynamic analysis on this <code>strlen</code> will report an issue because you read outside of the allocated memory. For <code>asan</code> and <code>tsan</code> we have special modifier <code>unsafe</code>. When we call <code>eve::unsafe(eve::load)(aligned_s)</code>, EVE detects build with these sanitizers and disable them for this load. <code>wide(ptr)</code> constructor does not have a way to do this.</li>
</ul>
<h3><a class="anchor" id="autotoc_md33"></a>
&lt;tt&gt;cur == zeroes&lt;/tt&gt;</h3>
<p>This is an elementwise comparison for equality between <code>cur</code> and <code>zeroes</code>. The result is <code>eve::logical&lt;wide&gt;</code> - a class representing N booleans where N is the cardinal of our wide.</p>
<h3><a class="anchor" id="autotoc_md34"></a>
&lt;tt&gt;eve::ignore_first ignore / eve::first_true[ignore]&lt;/tt&gt;</h3>
<p><code>first_true</code> takes a <code>logical</code> and returns the optional position of the first <code>true</code> element. However we compute <code>previous_aligned_address(s)</code> and not just <code>s</code>, so there might be some 0s we are not interested in. <br  />
 For this purpose <code>eve</code> provides some conditional mutators, most commonly used ones are: <code>ignore_first</code>, <code>ignore_last</code>, <code>ignore_extrema</code> (ignores from both sides).</p>
<h3><a class="anchor" id="autotoc_md35"></a>
&lt;tt&gt;while (!match) / aligned_s += wide::static_size&lt;/tt&gt;</h3>
<p>While we didn't find the 0, we go to the next chunk. <code>wide::static_size</code> is the cardinal of the <code>wide</code>. Alternatively we could have used <code>wide.size()</code>. but <code>static_size</code> has the advantage of being <code>constexpr</code> friendly.</p>
<h3><a class="anchor" id="autotoc_md36"></a>
&lt;tt&gt;match = eve::first_true(cur == zeroes);&lt;/tt&gt;</h3>
<p>This is the same <code>first_true</code> but we no longer need to ignore anything.</p>
<h3><a class="anchor" id="autotoc_md37"></a>
&lt;tt&gt;aligned_s.get() + *match - s&lt;/tt&gt;</h3>
<p>Finally, compute where we finished.</p>
<h1><a class="anchor" id="autotoc_md38"></a>
Comparison with real strlens</h1>
<p>The code above closely resembles <a href="https://opensource.apple.com/source/Libc/Libc-997.90.3/x86_64/string/strlen.s">MacOs x86 strlen</a>. <br  />
 With EVE compiled for <code>sse2</code>: <a href="https://godbolt.org/z/hvr3P5">godbolt</a> <br  />
 The differences are minimal: clang handles the bit and address manipulations slightly differently.</p>
<p>When comparing against <a href="https://code.woboq.org/userspace/glibc/sysdeps/aarch64/multiarch/strlen_asimd.S.html">glibc arm-v8 (aarch64)</a> <br  />
 With eve we get: <a href="https://godbolt.org/z/nz5eWe">eve, aarch64</a>. <br  />
 The interesting differences are:</p><ul>
<li>they do not immediatly load from the previous aligned address for the first block. Instead they check if they load from s, and only if not, they start dealing with the previous address.</li>
<li>they compute position of the first match differently.</li>
<li>we compare with 0 and then look for <code>true</code> using <code>umaxv</code> instruction. They rely on 0 being unsigned minimum and use <code>uminv</code> on the register directly. Unfortunatly this trick only works for looking for 0 and we can look for arbitraty value.</li>
</ul>
<p>There are some substantial improvements one can make to this <code>strlen</code>, like unrolling which can be found in <a href="https://code.woboq.org/userspace/glibc/sysdeps/x86_64/multiarch/strlen-avx2.S.html">glibc avx2 implementation</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.20-->
<!-- start footer part -->
</div> <!-- DOXYSTRAP RELATED -->
</div> <!-- DOXYSTRAP RELATED -->
</div> <!-- DOXYSTRAP RELATED -->
</div> <!-- DOXYSTRAP RELATED -->
</div> <!-- DOXYSTRAP RELATED -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu May 13 2021 22:39:34 for E.V.E by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
